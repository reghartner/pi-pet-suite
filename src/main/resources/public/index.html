<!DOCTYPE html>
<html lang="en">
<head>
  <title>Harley's Treat Dispenser</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<body>

<div class="jumbotron text-center">
  <h1>Harley's Treat Dispenser</h1>
</div>

<div class="container">
  <div class="col-sm-4">
    <div class="row" style="padding-bottom:5px;">
      <button class="btn btn-success" onclick="recordGif()" style="width:200px; float:left">
        Get a new gif
        <span class="glyphicon glyphicon-camera" style="float:right" />
      </button>
    </div>
    <div class="row" style="padding-bottom:5px;">
      <button onclick="rewardNow()" class="btn btn-success" style="width:200px; float:left" >
        Reward now
        <span class="glyphicon glyphicon-bell" style="float:right" />
      </button>
    </div>
    <div class="row" style="padding-bottom:5px;">
      <button onclick="rewardAfter()" class="btn btn-success" style="width:200px; float:left" >
        Reward after
        <span id="rewardAfterMinutes">5</span>
        minutes
        <span class="glyphicon glyphicon-time" style="float:right" />
      </button>
    </div>
    <div class="row" style="padding-bottom:5px;">
      <button onclick="flipLargeTreatFlag()" class="btn btn-warning" id="largeTreatFlag" style="width:200px; float:left">
        <span id="largeTreatLabel">Large Treats Disabled</span>
        <span id="largeTreatStar" class="glyphicon glyphicon-star-empty" style="float:right" />
      </button>
    </div>
    <div class="row" style="padding-bottom:5px;">
      <button onclick="kill()" class="btn btn-danger" style="width:200px; float:left">
        Kill Active Rewards
        <span class="glyphicon glyphicon-remove" style="float:right" />
      </button>
    </div>
    <div class="row" style="padding-bottom:5px;">
      <img id="pirate" height="400"/>
    </div>
  </div>
  <div class="col-sm-8">
    <div class="row" style="padding-bottom:5px;">
      <h4 id="loading" class="media-heading">Latest Gif</h4>
      <img id="pic" class="media-object"  width="600" height="400"/>
    </div>
    <div class="row" id="eventList">
    </div>
  </div>
</div>

<script language="JavaScript" >
  var host = "http://treats:8080/"; //window.location;

  // Actions
  var largeTreat = false;
  flipLargeTreatFlag = function() {
    largeTreat = !largeTreat;
    if (largeTreat) {
      $("#largeTreatFlag").removeClass("btn btn-warning").addClass("btn btn-info");
      $("#largeTreatStar").removeClass("glyphicon glyphicon-star-empty").addClass("glyphicon glyphicon-star");
      $("#largeTreatLabel").text("Large Treats Enabled");
    } else {
      $("#largeTreatFlag").removeClass("btn btn-info").addClass("btn btn-warning");
      $("#largeTreatStar").removeClass("glyphicon glyphicon-star").addClass("glyphicon glyphicon-star-empty");
      $("#largeTreatLabel").text("Large Treats Disabled");
    }
  }

  recordGif = function() {
     $("#loading").text("Refreshing Image...");
     $.ajax({type: "POST",url: host + "api/recordGif"});
  }

  rewardNow = function() { $.ajax({ type: "POST", url: host + "api/reward?smallTreat= " + !largeTreat }); }

  rewardAfter = function() {
    var minutes = $("#rewardAfterMinutes").text();
     $.ajax({ type: "POST", url: host + "api/reward/after/" + minutes + "?smallTreat= " + !largeTreat });
  }

  kill = function() { $.ajax({ type: "POST", url: host + "api/reward/kill" }); }

  // Image management
  $("#pirate").attr("src", host + "api/gifArchive/pirate.gif");
  $("#pic").attr("src", host + "api/gifArchive/latest?" + new Date().getTime());
  pic.onload = function () { $("#loading").text("Latest Gif"); }

  refreshPic = function() {
    $("#loading").text("Refreshing Image...");
    $("#pic").attr("src", host + "api/gifArchive/latest?" + new Date().getTime());
  }

  // Event polling

  eventList = document.createElement('ul');
  document.getElementById('eventList').appendChild(eventList);

  pollForEvents = function() {
    $.get(host + "api/events", function(data) {
        if (data) {
          data.forEach(function (event) {
          let li = document.createElement('li');
          eventList.appendChild(li);
          if (event.indexOf('New gif available!') > 0) {
            refreshPic();
          }
          li.innerHTML += event;
          });
        }
        setTimeout(pollForEvents,5000);
    });
  }

  pollForEvents();
</script>

</body>
</html>
